name: Generate from separate file
on:
  # Improvements for public repository forks
  # new `pull_request_target` event
  # https://github.blog/2020-08-03-github-actions-improvements-for-fork-and-pull-request-workflows/
  pull_request_target:
    # By default workflow runs on `opened` type
    types: [ opened ]
    branches: [ main ]
    # If at least one path matches a pattern in the paths filter, the workflow runs
    paths: [ '_data/players/**' ]
jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        name: Checkout
      - uses: actions/github-script@v3
        name: Query file
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const files = await github.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.number
            });
            console.log('context.payload.number', context.payload.number);
            console.log('context.payload.sender.login', context.payload.sender.login);
            const script = require(`${process.env.GITHUB_WORKSPACE}/js/script.js`);
            console.log('script returned', script({github, context, files}));
      - name: Automerge
        uses: pascalgn/automerge-action@v0.12.0
        env:
          MERGE_LABELS: ""
          MERGE_COMMIT_MESSAGE: "Automerge pull-request"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
